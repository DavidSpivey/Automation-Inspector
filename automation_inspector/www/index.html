<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Automation Inspector</title>
  <style>
    :root {
      --bg-body: var(--primary-background-color);
      --text-primary: var(--primary-text-color);
      --text-disabled: var(--disabled-text-color, #888);
      --card-bg: var(--card-background-color);
      --divider: var(--divider-color);
      --code-bg: var(--card-background-color);
      --error-bg: var(--error-color-container, #fdd);
      --error-text: var(--error-color, #900);
    }

    body {
      font-family: var(--font-family, sans-serif);
      margin: 1rem;
      background: var(--bg-body);
      color: var(--text-primary);
    }
    h1 {
      margin: .2rem 0 1rem 0;
    }
    #banner {
      margin: .6rem 0;
      font-weight: 600;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card-bg);
    }
    th, td {
      padding: .35rem .6rem;
      border-bottom: 1px solid var(--divider);
      vertical-align: top;
    }
    thead th {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 1;
    }
    tr:nth-child(even) {
      background: var(--secondary-background-color);
    }
    tr.disabled td:first-child {
      color: var(--text-disabled);
    }
    code {
      background: var(--code-bg);
      border: 1px solid var(--divider);
      padding: 2px 4px;
      border-radius: 4px;
      margin: 2px 3px 2px 0;
      display: inline-block;
      color: var(--text-primary);
    }
    code.bad {
      background: var(--error-bg);
      color: var(--error-text);
      border-color: var(--error-text);
    }
    a {
      color: var(--primary-text-color);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    input[type="checkbox"] {
      margin-right: .3rem;
    }
  </style>
</head>
<body>

<h1>Automation Inspector – Add-on</h1>
<div id="banner">Loading…</div>
<label>
  <input type="checkbox" id="errOnly"> show errors only
</label>

<table id="tbl">
  <thead>
    <tr><th>Automation</th><th>Entities</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let DATA={};

async function fetchData(){
  const resp = await fetch('dependency_map.json');
  DATA = await resp.json();
}

function render(){
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  const errOnly = document.getElementById("errOnly").checked;
  let errCount=0, entCount=0, badEnts=0;

  Object.values(DATA).forEach(info=>{
    const hasBad = info.entities.some(e=>!e.ok);
    if (errOnly && !hasBad) return;

    const tr = document.createElement("tr");
    if (!info.enabled) tr.classList.add("disabled");

    const trace = info.config_id
      ? `<a href="/config/automation/edit/${info.config_id}" target="_blank">▶</a> `
      : "";

    const ents = info.entities.map(e=>{
      const cls = e.ok? "" : "bad";
      const link = `/developer-tools/state?entity_id=${encodeURIComponent(e.id)}`;
      if (!e.ok) badEnts++;
      return `<a href="${link}" target="_blank">
                <code class="${cls}">${e.id}: ${e.state}</code>
              </a>`;
    }).join(" ");

    entCount += info.entities.length;
    if (hasBad) errCount++;

    tr.innerHTML = `
      <td>${trace}<strong>${info.friendly_name}</strong></td>
      <td>${ents}</td>
    `;
    tbody.appendChild(tr);
  });

  const autoTotal = Object.keys(DATA).length;
  document.getElementById("banner").textContent =
    `${autoTotal} automations · ${entCount} entities — `
    + (errCount
        ? `${errCount} automations with issues, ${badEnts} bad entities`
        : `all OK`);
}

async function load(){
  await fetchData();
  render();
}

document.getElementById("errOnly").addEventListener("change", render);
load();
</script>
</body>
</html>
