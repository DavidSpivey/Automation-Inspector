<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Automation Inspector</title>
  <style>
    :root {
      --bg-body: var(--primary-background-color);
      --text-primary: var(--primary-text-color);
      --text-disabled: var(--disabled-text-color, #888);
      --card-bg: var(--card-background-color);
      --secondary-bg: var(--secondary-background-color);
      --divider: var(--divider-color);
      --error-bg: var(--error-color-container, #fdd);
      --error-text: var(--error-color, #900);
    }

    /* Force HA theme text color */
    body { color: var(--primary-text-color) !important; }
    a { color: var(--primary-text-color) !important; }
    code:not(.bad) { color: var(--primary-text-color) !important; }

    body {
      font-family: var(--font-family, sans-serif);
      margin: 1rem;
      background: var(--bg-body);
    }
    h1 { margin: .2rem 0 1rem 0; }
    #banner { margin: .6rem 0; font-weight: 600; }
    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card-bg);
    }
    th, td {
      padding: .35rem .6rem;
      border-bottom: 1px solid var(--divider);
      vertical-align: top;
    }
    thead th {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 1;
    }
    tr:nth-child(even) { background: var(--secondary-bg); }
    tr.disabled td:first-child { color: var(--text-disabled); }

    code {
      background: var(--secondary-bg);
      border: 1px solid var(--divider);
      padding: 2px 4px;
      border-radius: 4px;
      margin: 2px 3px 2px 0;
      display: inline-block;
    }
    code.bad {
      background: var(--error-bg);
      color: var(--error-text);
      border-color: var(--error-text);
    }
    input[type="checkbox"] { margin-right: .3rem; }
    button { margin-left: 1rem; }
  </style>
</head>
<body>

<h1>Automation Inspector – Add-on</h1>
<div id="banner">Loading…</div>

<label>
  <input type="checkbox" id="errOnly"> show errors only
</label>

<button id="toggleDark">Toggle Dark Mode</button>

<table id="tbl">
  <thead>
    <tr><th>Automation</th><th>Entities</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let DATA = {};

// Detect Ingress vs direct access
const isIngress = window.location.pathname.includes('/api/hassio_ingress');
const HA_BASE = isIngress ? '' : `${location.protocol}//${location.hostname}:8123`;

async function fetchData(){
  const resp = await fetch('dependency_map.json');
  DATA = await resp.json();
}

function render(){
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  const errOnly = document.getElementById("errOnly").checked;
  let errCount=0, entCount=0, badEnts=0;

  Object.values(DATA).forEach(info => {
    const hasBad = info.entities.some(e => !e.ok);
    if (errOnly && !hasBad) return;

    const tr = document.createElement("tr");
    if (!info.enabled) tr.classList.add("disabled");

    // Trace link opens in same frame
    const trace = info.config_id
      ? `<a href="${HA_BASE}/config/automation/edit/${info.config_id}" target="_self">▶</a> `
      : "";

    const ents = info.entities.map(e => {
      const cls = e.ok ? "" : "bad";
      const link = `${HA_BASE}/developer-tools/state?entity_id=${encodeURIComponent(e.id)}`;
      if (!e.ok) badEnts++;
      return `<a href="${link}" target="_self">
                <code class="${cls}">${e.id}: ${e.state}</code>
              </a>`;
    }).join(" ");

    entCount += info.entities.length;
    if (hasBad) errCount++;

    tr.innerHTML = `
      <td>${trace}<strong>${info.friendly_name}</strong></td>
      <td>${ents}</td>
    `;
    tbody.appendChild(tr);
  });

  const autoTotal = Object.keys(DATA).length;
  document.getElementById("banner").textContent =
    `${autoTotal} automations · ${entCount} entities — `
    + (errCount
        ? `${errCount} automations with issues, ${badEnts} bad entities`
        : `all OK`);
}

async function load(){
  await fetchData();
  render();
}

// Error-only toggle
document.getElementById("errOnly").addEventListener("change", render);

// Dark mode toggle & persistence
document.getElementById("toggleDark").addEventListener("click", () => {
  document.documentElement.classList.toggle('dark-mode');
  localStorage.setItem('dark-mode', document.documentElement.classList.contains('dark-mode'));
});

// Apply saved dark-mode preference
if (localStorage.getItem('dark-mode') === 'true') {
  document.documentElement.classList.add('dark-mode');
}

load();
</script>
</body>
</html>
