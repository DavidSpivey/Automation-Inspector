<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Automation Inspector</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:   var(--primary-background-color,#1e1e1e);
  --fg:   var(--primary-text-color,#e0e0e0);
  --card: var(--ha-card-background-color,#2b2b2b);
  --warn: #ff6d6d;
  --accent:#2196f3;
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--fg)}
header{display:flex;align-items:center;gap:.6rem;padding:.5rem 1rem;background:#333;position:sticky;top:0;z-index:10}
h1{margin:0;font-size:1rem;color:var(--fg)}
button{cursor:pointer;border:1px solid #555;border-radius:4px;background:#000;color:var(--fg);padding:.3rem .6rem}
#search{flex:1;border:1px solid #555;border-radius:4px;padding:.4rem;background:#000;color:var(--fg)}
.stat{background:var(--accent);border-radius:6px;font-size:.8rem;padding:.2rem .5rem;color:#fff}
#age-chip{font-size:.8rem;opacity:.8}
#spinner{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);font-size:1.2rem;z-index:9}
.section{margin:1rem;border:1px solid #444;border-radius:6px;background:var(--card)}
.section.alert{border-color:var(--warn)}
.section>summary{padding:.6rem;font-weight:600;outline:none;cursor:pointer}
.section.alert>summary{color:var(--warn)}
.section ul{margin:.3rem 0 0 1rem;padding:0}
.section li{line-height:1.4}
.val{font-style:italic}
.off{color:var(--warn)}
.warn{color:var(--warn)}
.age{font-size:.8em;opacity:.7}
label.toggle{display:flex;align-items:center;gap:.3rem;font-size:.8rem;cursor:pointer}
</style>
</head>
<body>

<header>
  <h1>Automation Inspector</h1>
  <span id="summary" class="stat"></span>
  <span id="age-chip"></span>

  <input id="search" placeholder="Search automations‚Ä¶">
  <label class="toggle">
    <input type="checkbox" id="issues-only">
    Issues only
  </label>

  <button id="refresh" title="Refresh">‚ü≥</button>
  <button id="toggle"  title="Toggle dark/light">üåô</button>
</header>

<div id="spinner">Loading‚Ä¶</div>
<main id="list"></main>

<script>
const CACHE="inspector_map_v4";
let darkForced=null;
let issuesOnly=false;

/* ‚îÄ‚îÄ‚îÄ theme ‚îÄ‚îÄ‚îÄ */
function setTheme(force){
  if(force!==null) darkForced=force;
  const d=darkForced??matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.style.setProperty('--bg', d?'#1e1e1e':'#fafafa');
  document.documentElement.style.setProperty('--fg', d?'#e0e0e0':'#111');
  document.getElementById('toggle').textContent=d?'‚òÄÔ∏è':'üåô';
}
setTheme(null);
document.getElementById('toggle').onclick=()=>setTheme(!(darkForced??false));

/* ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ */
async function j(u){const r=await fetch(u);if(!r.ok)throw await r.text();return r.json();}
function clearCache(){sessionStorage.removeItem(CACHE);}
function fmtAge(sec){if(sec<60)return sec+' s';const m=Math.round(sec/60);return m+' m';}

/* ‚îÄ‚îÄ‚îÄ global refs ‚îÄ‚îÄ‚îÄ */
const spinner=document.getElementById('spinner');
const list   =document.getElementById('list');
const search =document.getElementById('search');
const issuesChk=document.getElementById('issues-only');

/* ‚îÄ‚îÄ‚îÄ build page ‚îÄ‚îÄ‚îÄ */
async function build(force){
  if(force) clearCache();
  spinner.style.display='flex';

  let map;
  const c=sessionStorage.getItem(CACHE);
  if(c&&!force){map=JSON.parse(c);}else{map=await j('/dependency_map.json');sessionStorage.setItem(CACHE,JSON.stringify(map));}

  const {_summary:{generated_at,...s}}=map;
  const ageSec=Math.round((Date.now()-Date.parse(generated_at))/1000);
  document.getElementById('age-chip').textContent=`updated ${fmtAge(ageSec)} ago`;
  document.getElementById('summary').textContent=`${s.total} auto ¬∑ ${s.unknown+s.offline+s.stale} alerts`;

  list.innerHTML='';
  Object.entries(map).filter(([k])=>!k.startsWith('_')).forEach(([id,info])=>{
    const hasAlert=info.unknown_triggers.length||info.offline_members.length||
                   (info.stale_days!==null&&info.stale_days>=info.stale_threshold);

    const sec=document.createElement('details');
    sec.className='section'+(hasAlert?' alert':'');
    sec.dataset.friendly=info.friendly_name.toLowerCase();
    sec.dataset.alert=hasAlert?'1':'0';
    sec.open=false;

    sec.innerHTML=`<summary><a href="${info.ui_link}" target="_blank">${info.friendly_name}</a></summary>`;
    const ul=document.createElement('ul');

    info.entities.forEach(e=>{
      const off=e.state==='unavailable';
      const stale=e.age>120;
      ul.insertAdjacentHTML('beforeend',
        `<li class="${off?'off':''}">${e.id} = <span class="val">${e.state}${e.unit?' '+e.unit:''}</span> <span class="age ${stale?'off':''}">‚Ä¢ ${fmtAge(e.age)} ago</span></li>`);
    });

    if(info.unknown_triggers.length){
      ul.insertAdjacentHTML('beforeend','<li class="warn">‚ö† unknown triggers</li>');
      info.unknown_triggers.forEach(t=>ul.insertAdjacentHTML('beforeend',`<li class="warn">${t}</li>`));
    }
    if(info.offline_members.length){
      ul.insertAdjacentHTML('beforeend','<li class="warn">‚ö† offline members</li>');
      info.offline_members.forEach(m=>ul.insertAdjacentHTML('beforeend',`<li class="warn">${m}</li>`));
    }
    if(info.stale_days!==null&&info.stale_days>=info.stale_threshold){
      ul.insertAdjacentHTML('beforeend',`<li class="warn">‚è∞ not run for ${info.stale_days} d</li>`);
    }
    sec.appendChild(ul);
    list.appendChild(sec);
  });

  applyFilters();
  spinner.style.display='none';
}
build(false);

/* ‚îÄ‚îÄ‚îÄ filtering ‚îÄ‚îÄ‚îÄ */
function applyFilters(){
  const q=search.value.toLowerCase();
  document.querySelectorAll('.section').forEach(sec=>{
    const matchText=sec.dataset.friendly.includes(q);
    const matchAlert=!issuesOnly||sec.dataset.alert==='1';
    sec.style.display=(matchText&&matchAlert)?'':'none';
  });
}
search.addEventListener('input',applyFilters);
issuesChk.addEventListener('change',e=>{issuesOnly=e.target.checked;applyFilters();});

/* ‚îÄ‚îÄ‚îÄ refresh ‚îÄ‚îÄ‚îÄ */
document.getElementById('refresh').onclick=()=>build(true);
</script>
</body>
</html>
